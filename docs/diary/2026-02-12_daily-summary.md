# 2026-02-12 작업 일지

## 수치 요약

| 지표 | 값 |
|------|-----|
| 커밋 | 14건 |
| 변경 파일 | 89개 |
| 코드 추가 | +11,853줄 |
| 코드 삭제 | -1,831줄 |
| 순 증가 | +10,022줄 |

---

## 1. AI 앨범 v2 시스템 구축 (7커밋, 16:30~18:24)

하루 작업의 핵심. 기존 단일 AI 포토 스튜디오를 **멀티앨범 기반 시스템**으로 전면 재설계.

### 1-1. 앨범 생성 간소화 + URL 분리 (`3c9a916`)
- 앨범 리스트(`/ai-photos`)와 상세(`/ai-photos/[albumId]`) 페이지 분리
- AlbumOnboarding 컴포넌트 신규 생성
- 기존 단일 페이지(592줄) 리팩토링 → 434줄 추가, 480줄 삭제

### 1-2. 멀티앨범 + 큐레이션 API (`a51fc78`)
- **DB**: `aiAlbums`, `aiAlbumGroups` 테이블 + 마이그레이션 2개
- **API**: 앨범 CRUD(`/api/ai/albums`), 큐레이션 적용(`/api/ai/albums/[id]/apply`)
- **UI**: AlbumDashboard(835줄), AlbumCuration(493줄), SnapTypeSelector 신규
- 스키마/타입 정의 (`schemas/ai.ts`, `types/ai.ts`)
- **3,472줄 추가** — 오늘 가장 큰 커밋

### 1-3. 앨범 관리 UX 개선 (`d162c00`)
- 앨범 삭제/수정/필터/기본그룹 기능
- AlbumDashboard에 편집 모드 추가

### 1-4. 리스트 뷰 모드 + 앨범 제한 (`a96feec`)
- 카드/리스트/갤러리 3가지 뷰 모드
- 앨범 최대 3개 제한 (무료 플랜 기준)

### 1-5. Job/크레딧/참조사진 시스템 — Phase 4 (`d14aaad`)
- **DB**: `aiGenerationJobs`, `aiReferencePhotos`, `aiCreditTransactions` 테이블
- **API**: Job CRUD, 참조사진 업로드, 크레딧 조회 엔드포인트
- **UI**: GenerationWizard(5단계), BatchGenerationView, CreditDisplay
- **Hook**: `useAIGeneration` — SSE 스트리밍 + Job 상태 관리
- `lib/ai/credits.ts` — reserveCredits/releaseCredits 트랜잭션 기반 크레딧 시스템
- **4,015줄 추가** — Phase 4 전체 일괄 구현

---

## 2. 참조 사진 업로드 개선 (4커밋, 18:29~20:24)

Phase 4 구현 후 실제 사용 테스트하면서 발견된 UX 문제들을 연속 수정.

### 2-1. AlbumDashboard 위자드 전환 + 온보딩 (`0ae8b0a`)
- AlbumDashboard를 위자드 기반으로 재구성
- AlbumOnboarding에 참조사진 단계 추가 (502줄로 확장)

### 2-2. Dead link → 인라인 업로드 (`1db2b82`)
- 참조 사진 등록이 외부 링크로 연결되던 문제 → 인라인 업로드 UI로 교체

### 2-3. 얼굴 감지 non-blocking (`1681feb`)
- 참조 사진 업로드 시 얼굴 감지를 blocking → non-blocking으로 전환
- 얼굴 미감지 시에도 업로드 허용 (경고만 표시)

### 2-4. 2단계 업로드 플로우 (`7bff10d`)
- 즉시 업로드 → 프리뷰→확인→업로드 2단계로 변경
- 사용자가 사진 확인 후 업로드 여부 결정

### 2-5. 참조 사진 시스템 리팩토링 (`a7dfb2b`)
- ReferencePhotoSection 컴포넌트 분리 (442줄)
- AlbumDashboard 375줄 삭감
- generate API에서 referencePhotoId 기반 조회 로직 보강

---

## 3. 크레딧 시스템 정비 (1커밋, 20:25)

### 3-1. Dev 하드코딩 제거 + 어드민 트랜잭션 기록 (`401e75d`)

**제거한 것:**
- `lib/ai/credits.ts` — `IS_DEV` 상수 + 6개 함수의 dev 바이패스 (999 반환, 차감/환불 스킵)
- `app/api/user/credits/route.ts` — 999 반환 분기
- `app/api/ai/generate/route.ts` — 크레딧 체크 스킵 + `remainingCredits = 999`
- `app/api/ai/generate/stream/route.ts` — 크레딧 체크 스킵 + `IS_DEV ? 999 :` 삼항

**추가한 것:**
- 관리자 크레딧 부여 시 `aiCreditTransactions` 레코드 삽입 (`type: BONUS`, `referenceType: ADMIN`)
- DB 트랜잭션으로 크레딧 업데이트 + 이력 기록 원자성 보장

---

## 4. 어드민 패널 개선 (2커밋, 20:33~20:37)

### 4-1. 액션 popover z-index 수정 (`d56bba5`)
- `overflow-x-auto`가 CSS 클리핑 컨텍스트를 만들어 popover가 카드 밖으로 못 나가던 문제
- overflow 제거 + z-index 50으로 상향

### 4-2. 관리자 권한 부여/해제 기능 (`a639310`)
- `schemas/admin.ts` — `set_admin`, `set_user` 액션 스키마 추가
- `app/api/admin/users/route.ts` — role 변경 핸들러
- `components/admin/UserTable.tsx` — 메뉴에 "관리자 권한 부여" / "관리자 해제" 추가
- 관리자 해제 버튼은 빨간색으로 위험 동작 시각 구분

---

## 5. 문서 (`0ef5e63`)

- `ai-album-v2-design.md` (392줄) — 앨범 v2 아키텍처 설계
- `ai-photo-generation-impl-plan.md` (325줄) — 구현 계획
- `ai-photo-generation-redesign.md` (713줄) — 리디자인 전체 설계
- `2026-02-12_album-list-view-modes.md` (84줄) — 뷰 모드 결정 기록
- `2026-02-12_daily-review.md` (182줄) — 데일리 리뷰 (어제 리뷰 + 오늘 계획)

---

## 타임라인

| 시간 | 작업 |
|------|------|
| 16:30 | 앨범 생성 간소화 + URL 분리 |
| 16:31 | 멀티앨범 + 큐레이션 API (대규모) |
| 17:08 | 앨범 관리 UX 개선 |
| 17:18 | 리스트 뷰 모드 + 앨범 제한 |
| 18:24 | Job/크레딧/참조사진 Phase 4 (대규모) |
| 18:29 | 위자드 전환 + 온보딩 |
| 18:34 | Dead link → 인라인 업로드 |
| 18:36 | 얼굴 감지 non-blocking |
| 18:40 | 2단계 업로드 플로우 |
| 20:24 | 참조 사진 시스템 리팩토링 |
| 20:25 | 크레딧 dev 하드코딩 제거 |
| 20:26 | 설계 문서 정리 |
| 20:33 | popover z-index 수정 |
| 20:37 | 관리자 권한 부여/해제 |

---

## 남은 과제

- **공개 청첩장 뷰** (`inv/[id]`) — 여전히 미완, P1
- **결제 연동** — 워터마크 게이트 있으나 결제 플로우 없음
- **앨범 v2 테스트** — 실 사용 시나리오 검증 필요
- **크레딧 시스템 검증** — dev 바이패스 제거 후 실제 크레딧 소진 플로우 확인

---

## 시니어 개발자 / 팀장 피드백

### 계획 vs 실행 — 완전 이탈

2/12 데일리 리뷰에서 세운 계획:

| 계획 항목 | 실행 여부 |
|-----------|-----------|
| 1단계: P0 핫픽스 (Apply 경쟁조건, SSE 검증, URL 호스트 검증, 즐겨찾기 Zod) | **미실행** |
| 2단계: 공개 청첩장 뷰 (`inv/[id]`) | **미실행** |
| 3단계: 결제 연동 설계 | **미실행** |
| AI 테마 작업 금지 | 지킴 |
| 문서 최소화 | 설계 문서 1,514줄 추가 — **미이행** |

**계획한 3개 단계 중 실행한 것: 0개.** 대신 계획에 없던 AI 앨범 v2 시스템 구축에 하루를 통째로 씀.

### 반복되는 패턴 — 이게 세 번째

2/11 리뷰에서 지적한 문제:
- "AI 테마 작업 금지" 결정 → 당일 저녁에 테마 리팩토링
- 문서 과잉 투자 (~40%)
- 공개 청첩장 뷰 계속 밀림

2/12에도 동일 패턴:
- 아침에 "P0 핫픽스 먼저, 공개 뷰 오후에" → 실제로는 AI 앨범 v2에 올인
- 문서 최소화 약속 → 설계 문서 1,514줄 추가
- 공개 청첩장 뷰 "여전히 미완, P1"

**계획 세우는 데 쓴 시간이 낭비.** 계획을 안 지킬 거면 차라리 세우지 마라.

### 기술적 우려

#### 1. 순 증가 +10,022줄 — 위험 신호

하루에 1만 줄은 양이 아니라 부채다. 혼자 운영하는 프로젝트에서:
- 14커밋, 89파일 → 리뷰 없이 머지된 코드
- 4,015줄짜리 Phase 4 일괄 커밋 → 버그가 묻힐 확률 극도로 높음
- 이 코드를 3개월 뒤에 본인이 유지보수할 수 있나?

#### 2. P0 이슈 방치

2/11에 발견한 **Apply 경쟁 조건**(트랜잭션 없이 fetch-modify-write)이 아직 열려 있음. 그 위에 새 테이블 3개, API 엔드포인트 다수를 쌓았음. 기초에 금 가 있는데 위에 층을 올리는 격.

#### 3. DB 스키마 폭발

하루에 추가된 테이블: `aiAlbums`, `aiAlbumGroups`, `aiGenerationJobs`, `aiReferencePhotos`, `aiCreditTransactions`. 마이그레이션 여러 건. 이 테이블들 간 관계, 인덱스, cascade 정책을 충분히 검토했는가? 스키마 변경은 나중에 고치기 가장 비싼 결정.

#### 4. 크레딧 dev 바이패스 제거 — 타이밍 의문

앨범 v2가 아직 검증 안 된 상태에서 dev 바이패스를 먼저 제거. 개발 중 테스트하려면 매번 실제 크레딧을 써야 함. 순서가 반대 아닌가?

### PM 관점 — 사용자 가치 제로

14커밋, 89파일, 만 줄을 썼는데 **사용자가 체감하는 변화: 없음.**

- 공개 청첩장 뷰 없음 → 링크 공유 불가
- 결제 플로우 없음 → 수익 $0
- AI 앨범 v2 → 내부 시스템 변경, 사용자는 모름

"AI 앨범 시스템을 지금 꼭 해야 했나?" 기존 AI 포토 스튜디오도 동작하는 상태였음. 공개 뷰 + 결제가 있어야 서비스이고, 서비스가 있어야 AI 앨범 개선이 의미가 있음.

### 내일(2/13) 제안 — 이번엔 진짜 지켜라

| 순서 | 작업 | 예상 | 이유 |
|------|------|------|------|
| 1 | P0 핫픽스 (Apply 경쟁조건) | 1시간 | 2일째 방치. 더 미루면 위에 쌓이는 코드만 늘어남 |
| 2 | 공개 청첩장 뷰 (`inv/[id]`) 완성 | 반나절 | **서비스가 존재하려면 이게 있어야 함** |
| 3 | 결제 플로우 설계 (코드 아닌 설계만) | 1-2시간 | 워터마크 게이트 → 결제 → 프리미엄 전환 경로 확보 |
| 금지 | AI 앨범 v2 추가 작업 | - | 기존 코드 안정화 먼저 |
| 금지 | 새 설계 문서 작성 | - | 구현 중 인라인 주석으로 충분 |

### 한 줄 요약

**기술적 흥미 > 사용자 가치 순서로 일하고 있다. 계획을 세운 뒤 무시하는 습관이 굳어지고 있다. 공개 뷰와 결제 없이 AI를 아무리 고도화해도 서비스가 아니다.**
