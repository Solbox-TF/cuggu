# Cuggu DB 스키마 종합 리뷰 리포트

> 2026-02-13 | 8인 전문가 팀 리뷰 (DBA 3, PM 1, Backend 2, Frontend 2)

---

## 팀 구성 & 개별 점수

| 역할 | 전문 영역 | 점수 |
|------|-----------|------|
| PM | 비즈니스 요구사항 매핑 | **72** |
| DBA 1 | 스키마 설계 & 정규화 | **72** |
| DBA 2 | 인덱싱 & 쿼리 성능 | **52** |
| DBA 3 | 보안 & 데이터 무결성 | **55** |
| Backend 1 | ORM & API 설계 | **68** |
| Backend 2 | 트랜잭션 & 데이터 정합성 | **45** |
| Frontend 1 | 데이터 구조 & UX | **62** |
| Frontend 2 | 타입 & 스키마 일관성 | **52** |
| **평균** | | **59.75 / 100** |

---

## Critical 이슈 (다수 공통 지적)

### 1. 크레딧 시스템 감사 추적 공백 (6명 지적)

- `deductCredits()`/`refundCredits()`가 `ai_credit_transactions`에 이력을 남기지 않음
- 단건 AI 생성(`/api/ai/generate`), 테마 생성(`/api/ai/theme`) 경로의 크레딧 차감이 추적 불가
- `users.ai_credits`에 `CHECK (ai_credits >= 0)` 제약 없음 → 버그/수동 조작으로 음수 가능
- `refundCredits()`에 이중 환불 방어(멱등성 키) 없음

**영향**: 유저가 "크레딧이 왜 줄었는지 모르겠다"고 CS 문의 시 거래 내역에 아무것도 없음. 어드민도 추적 불가.

**수정 방향**:
- `deductCredits()`/`refundCredits()`에 `ai_credit_transactions` 기록 추가 (트랜잭션으로 묶기)
- `users.ai_credits`에 `CHECK (ai_credits >= 0)` 추가
- `payments.amount`, `ai_credit_transactions.amount`에 `CHECK (amount > 0)` 추가

### 2. CASCADE DELETE로 결제/크레딧 이력 삭제 (5명 지적)

- `payments`, `ai_credit_transactions` 모두 `onDelete: 'cascade'`
- 유저 삭제 시 결제 증빙 영구 소실
- 한국 개인정보보호법상 결제 기록 5년 보관 의무 위반 가능
- 유저 삭제 시 10개+ 테이블 연쇄 삭제 → long-running transaction

**영향**: 법적 리스크 + 환불/정산/세금 증빙 불가.

**수정 방향**:
- `payments` → `onDelete: 'restrict'`
- `ai_credit_transactions` → `onDelete: 'restrict'`
- 유저 삭제 시 soft delete 패턴 도입 (`deletedAt` 컬럼)

### 3. `timestamp without timezone` 전면 사용 (4명 지적)

- 모든 테이블의 모든 timestamp가 `without time zone`
- PostgreSQL 공식 권장은 `timestamptz` (`timestamp with time zone`)
- Vercel(UTC) + Supabase(UTC) 환경에서 현재는 동작하지만, 마이그레이션/백업/복원 시 타임존 불일치 위험
- `wedding_date`까지 without timezone이면 한국 외 시간대에서 날짜가 밀릴 수 있음

**수정 방향**:
```ts
// before
createdAt: timestamp('created_at').defaultNow().notNull(),
// after
createdAt: timestamp('created_at', { withTimezone: true }).defaultNow().notNull(),
```

### 4. AIStyle enum 3곳 완전 불일치 (3명 지적)

| 위치 | 값 |
|------|-----|
| `db/schema.ts` aiStyleEnum | Legacy 5개 + New 10개 = **15개** |
| `types/ai.ts` AIStyle | New 10개만 |
| `schemas/ai.ts` AIStyleSchema | **Legacy 5개만** |

- AI 사진 생성이 핵심 기능인데, 새 스타일이 Zod 검증에서 거부될 수 있음
- API route에서 로컬로 AIStyleSchema를 재정의해서 우회 중 → `schemas/ai.ts`의 공용 스키마는 죽은 코드

**수정 방향**: `schemas/ai.ts`의 `AIStyleSchema`를 DB enum 기준으로 동기화 (10분 작업)

### 5. RLS 정책 전무 (DBA 3)

- Supabase 쓰면서 Row Level Security가 하나도 없음
- API 레이어 인증만으로 방어 → 방어선 1개뿐
- Supabase anon key 유출 시 모든 유저 데이터 접근 가능

**수정 방향**: 최소한 `users`, `invitations`, `payments`, `ai_credit_transactions` 테이블에 RLS 활성화

---

## Major 이슈

### 스키마 설계

| # | 이슈 | 지적자 | 설명 |
|---|------|--------|------|
| 1 | FK 컬럼 인덱스 누락 | DBA 1, 2, BE 1 | `ai_generations.album_id`, `job_id`, `ai_generation_jobs.album_id`, `invitations.template_id`에 인덱스 없음. Job별 생성 목록 조회 시 full scan |
| 2 | `cost` 컬럼 `real` 타입 | DBA 1 | 부동소수점 오차 발생. `numeric(10,6)` 또는 센트 단위 integer로 변경 필요 |
| 3 | `templates.config` text 타입 | DBA 1, BE 1 | 다른 곳은 jsonb 쓰면서 여기만 text. JSON 유효성 검증/인덱싱 불가 |
| 4 | `ai_style` enum 15개 & 증가 예상 | DBA 1 | PostgreSQL enum은 값 삭제 불가. varchar + 앱 레벨 검증으로 전환 권장 |
| 5 | Enum 케이싱 불일치 | DBA 1, FE 1, 2 | `ai_album_status`(소문자) vs 나머지(대문자). 프론트에서 비교 시 혼란 |
| 6 | RSVP 중복 제출 방지 없음 | PM | `(invitation_id, guest_phone)` UNIQUE 제약 필요 |
| 7 | 프리미엄 플랜 만료일 없음 | PM | `premium_expires_at`, `premium_started_at` 컬럼 추가 필요 |
| 8 | `payments.paymentKey` UNIQUE 없음 | DBA 3 | 결제 중복 처리 방지 안 됨. 동일 paymentKey로 크레딧 이중 지급 가능 |
| 9 | NULL 쌍 CHECK 없음 | DBA 1, 3 | `reference_type`/`reference_id` 둘 다 NULL이거나 둘 다 NOT NULL이어야 함 |

### 트랜잭션 & 동시성

| # | 이슈 | 지적자 | 설명 |
|---|------|--------|------|
| 10 | Job 완료 PATCH 이중 호출 취약 | BE 2 | 동시 2개 PATCH → `releaseCredits()` 2번 호출 → 미사용 크레딧 2배 환불 |
| 11 | Job 미완료 시 크레딧 영구 잠김 | BE 2 | 유저가 배치 생성 중 탭 닫으면 Job이 PROCESSING에 멈추고, 예약 크레딧 미반환. Timeout/크론 없음 |
| 12 | 단건 생성 크레딧~DB저장 비원자적 | BE 2 | `deductCredits()` → S3 → Replicate → DB insert. 중간 실패 시 크레딧 차감됐는데 기록 없음 |
| 13 | 어드민 크레딧 부여 race condition | BE 2 | read-then-write 패턴. `SET aiCredits = aiCredits + amount` SQL 패턴으로 변경 필요 |
| 14 | JSONB 앨범 동시 수정 | BE 2, FE 1 | 전체 배열 교체(last-write-wins). 낙관적 잠금/ETag 없음 |

### ORM & API

| # | 이슈 | 지적자 | 설명 |
|---|------|--------|------|
| 15 | Relations 누락 | BE 1 | `invitations ↔ aiAlbums`, `aiAlbums ↔ aiGenerationJobs` 역방향 관계 미정의 |
| 16 | 마이그레이션 수동/자동 혼재 | BE 1 | `_journal.json`에 6개만 등록, 실제 파일은 10개. drizzle-kit이 수동 마이그레이션 인식 못함 |
| 17 | `updatedAt` 수동 업데이트 반복 | BE 1 | 15곳 이상에서 `updatedAt: new Date()` 수동 삽입. `$onUpdate()` 활용 가능 |
| 18 | N+1 쿼리 (`GET /api/ai/albums`) | BE 1 | 앨범 수만큼 generation 쿼리 발생. `with: { generations: true }`로 1번에 가능 |
| 19 | `extendedData` 타입 `Record<string, unknown>` | BE 1, FE 1 | 너무 느슨. `ExtendedData` 인터페이스 필요 |
| 20 | `replicateId` deprecated인데 코드에서 사용 중 | BE 1 | `providerJobId`와 동일 값 중복 저장. 정리 필요 |

### 프론트엔드 타입 & 데이터

| # | 이슈 | 지적자 | 설명 |
|---|------|--------|------|
| 21 | `invitations` DB↔Frontend 모델 불일치 | FE 1 | DB는 flat 컬럼, Frontend는 nested 구조. 변환 레이어 버그 시 사용자 입력 데이터 소실 |
| 22 | Zustand 스토어 `invitation: any` | FE 1 | 편집기 전체에서 타입 안전성 없음. 자동완성/리팩토링 불가 |
| 23 | AlbumImage/AlbumGroup 타입 3중 정의 | FE 2 | `db/schema.ts`, `types/ai.ts`, `schemas/ai.ts`에서 각각 다른 타입으로 정의 |
| 24 | JobConfig 2중 정의 (타입 불일치) | FE 2 | DB는 `string[]`, Frontend는 `AIStyle[]`. 캐스팅 필요 |
| 25 | `aiThemes` Zod 스키마 부재 | FE 2 | 테마 생성 입력 검증 없음 |
| 26 | `aiGenerationJobs.config` JSONB 무검증 | FE 2 | `JobConfig` 런타임 검증 없음 |
| 27 | RSVP 목록 페이지네이션 없음 | FE 1 | 전체 목록 한 번에 반환. 수백 건 시 느려짐 |
| 28 | `templates.config` 목록 조회 시 전체 로드 | FE 1 | 한 템플릿당 수 KB. 목록에선 id/name/thumbnail만 필요 |
| 29 | `customTheme`이 `z.any()`로 무검증 | FE 1 | 잘못된 테마 데이터 저장 시 공개 청첩장 렌더링 깨짐 |

### 보안

| # | 이슈 | 지적자 | 설명 |
|---|------|--------|------|
| 30 | OAuth 토큰 평문 저장 | DBA 3 | `accounts` 테이블의 access/refresh/id token. NextAuth 표준이라 변경 어렵지만 리스크 인지 필요 |
| 31 | 관리자 작업 감사 로그 없음 | DBA 3 | role 변경, 크레딧 부여 등 추적 불가 |
| 32 | users soft delete 미구현 | DBA 3 | 유저 탈퇴 = 물리 삭제 → 복구 불가 |
| 33 | 결제 상태 변경 이력 없음 | DBA 3 | PENDING → COMPLETED → REFUNDED 전이 이력 미기록 |
| 34 | `view_count` 동시성 미제어 | DBA 3 | 결혼식 시즌 높은 트래픽에서 부정확한 조회수 |

---

## 잘 된 부분

- AI 도메인 6개 테이블 설계가 탄탄함 (앨범, 잡, 참조사진, 테마, 크레딧, 생성)
- 크레딧 동시 차감은 `WHERE aiCredits >= amount` 패턴으로 합리적 방어
- RSVP 개인정보(전화번호, 이메일) AES-256-GCM 암호화 적용
- 계좌번호 암호화 적용
- Invitation 편집기 낙관적 업데이트 (2초 debounce + 3회 retry + localStorage 백업)
- cuid2 PK 선택 (URL-safe, 충돌 안전, ID enumeration 방지)
- Zod 스키마 커버리지 대체로 양호 (17개 테이블 중 14개 커버)
- 페이지네이션 기반 설계 (PaginationQuerySchema, PaginationMetaSchema) 잘 깔려있음
- `ai_generation_jobs.config`의 `$type<JobConfig>()` JSONB 타입 바인딩 적절

---

## 수정 우선순위 로드맵

### P0 — 즉시 (출시 전 필수)

| # | 작업 | 난이도 | 예상 시간 |
|---|------|--------|-----------|
| 1 | `payments`, `ai_credit_transactions` FK → `onDelete: 'restrict'` | 쉬움 | 30분 |
| 2 | `deductCredits()`/`refundCredits()`에 트랜잭션 이력 기록 추가 | 중간 | 2시간 |
| 3 | `users.ai_credits`에 `CHECK (ai_credits >= 0)` 추가 | 쉬움 | 15분 |
| 4 | AIStyle enum 3곳 동기화 | 쉬움 | 10분 |

### P1 — 이번 스프린트

| # | 작업 | 난이도 | 예상 시간 |
|---|------|--------|-----------|
| 5 | `timestamp` → `timestamptz` 전면 전환 | 중간 | 1시간 |
| 6 | FK 컬럼 인덱스 추가 (album_id, job_id 등) | 쉬움 | 30분 |
| 7 | `cost` 컬럼 `real` → `numeric(10,6)` | 쉬움 | 30분 |
| 8 | RSVP 중복 제출 방지 UNIQUE 제약 | 쉬움 | 30분 |
| 9 | 프리미엄 만료일 (`premium_expires_at`) 추가 | 쉬움 | 30분 |
| 10 | Job 완료 PATCH 멱등성 보장 | 중간 | 1시간 |
| 11 | Job timeout 크론/정리 로직 | 중간 | 2시간 |

### P2 — 다음 스프린트

| # | 작업 | 난이도 | 예상 시간 |
|---|------|--------|-----------|
| 12 | `templates.config` text → jsonb | 쉬움 | 30분 |
| 13 | `ai_style` enum → varchar 전환 | 중간 | 1시간 |
| 14 | Relations 누락 보완 | 쉬움 | 30분 |
| 15 | 핵심 테이블 RLS 활성화 | 어려움 | 3시간 |
| 16 | Zustand `any` → 정확한 타입 교체 | 중간 | 1시간 |
| 17 | `extendedData` 타입 인터페이스 정의 | 중간 | 1시간 |
| 18 | N+1 쿼리 수정 (albums) | 쉬움 | 30분 |
| 19 | `updatedAt` 자동화 (`$onUpdate`) | 쉬움 | 30분 |
| 20 | AlbumImage/AlbumGroup 타입 단일화 | 중간 | 1시간 |

### P3 — 백로그

| # | 작업 | 난이도 |
|---|------|--------|
| 21 | CHECK 제약 추가 (referenceType/Id 쌍, passwordHash 등) | 쉬움 |
| 22 | varchar PK 길이 128 → 32 축소 | 중간 |
| 23 | Enum 케이싱 통일 | 중간 |
| 24 | 공유/초대 추적 테이블 | 중간 |
| 25 | 마이그레이션 파일 정리 (journal 동기화) | 중간 |
| 26 | `replicateId` deprecated 컬럼 제거 | 쉬움 |
| 27 | 감사 로그 테이블 | 어려움 |
| 28 | soft delete 패턴 도입 | 중간 |
| 29 | 결제 상태 변경 이력 테이블 | 중간 |
| 30 | `payments.paymentKey` UNIQUE 추가 | 쉬움 |

---

## 리뷰어별 상세 의견 요약

### PM (72점)
> AI 도메인은 탄탄하게 잘 짜놨는데, 정작 돈 버는 구조(프리미엄 만료, 결제 상세)와 서비스 핵심 KPI(공유 추적, RSVP 중복방지)에 구멍이 있음.

### DBA 1 — 스키마 설계 (72점)
> 기본 구조는 괜찮지만 `timestamp without timezone` 전면 사용, 금융 데이터 cascade 삭제, FK 인덱스 누락이 프로덕션 가기 전에 반드시 수정해야 할 이슈.

### DBA 2 — 인덱싱 (52점)
> FK 인덱스 기본은 갖춰져있지만, 핵심 쿼리 경로(앨범-이미지, Job-생성)에 인덱스가 빠져있고, 크레딧 동시성 보호가 없어서 돈 관련 버그가 터질 조건이 갖춰져 있다.

### DBA 3 — 보안 (55점)
> 앱 레이어 보안(암호화, 인증, Rate Limit)은 괜찮은데, DB 레이어 방어(RLS, CHECK, CASCADE 정책, 감사 추적)가 거의 없어서 운영 사고 시 데이터 복구/추적이 불가능한 구조.

### Backend 1 — ORM/API (68점)
> Relations 정의 누락, 마이그레이션 이원화, 크레딧 트랜잭션 이력 공백이 가장 큰 리스크이고, 나머지는 타입 안전성과 쿼리 효율성의 점진적 개선 영역.

### Backend 2 — 트랜잭션 (45점)
> 크레딧 시스템의 감사 추적이 반만 구현되어 있고, 동시성 제어가 애플리케이션 레벨에 과도하게 의존하고 있어서, 유저가 늘어나면 크레딧 정합성 문제가 CS로 터질 것이다.

### Frontend 1 — 데이터/UX (62점)
> Zod 스키마와 JSONB 구조 설계는 탄탄하지만, AIStyle enum 3곳 불일치와 DB↔프론트엔드 모델 불일치가 핵심 기능의 신뢰성을 흔드는 수준.

### Frontend 2 — 타입 일관성 (52점)
> AIStyle enum 3중 불일치가 전체 AI 파이프라인 신뢰성을 깎고 있고, JSONB 컬럼 무검증 + 타입 3중 정의가 유지보수 부채를 키우고 있음. Zod 스키마를 single source of truth로 통합 급선무.

---

## 한줄 총평

**전체 구조와 도메인 모델링은 1인 개발자 치고 상당히 잘 잡혀있지만, 돈이 오가는 경로(크레딧/결제)의 DB 레벨 안전장치와 타입 동기화가 프로덕션에 나가기엔 부족하다. P0 4개만 잡으면 70점대로 올라갈 수 있다.**
