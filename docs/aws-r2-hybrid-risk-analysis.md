# Cuggu AWS + R2 하이브리드 리스크 분석

> 최종 업데이트: 2026-02-24

---

## 1. 운영 복잡도 증가

```
순수 AWS:     AWS 콘솔 1개만 보면 됨
하이브리드:   AWS 콘솔 + Cloudflare 대시보드 + Vercel 대시보드 (개발)

장애 시 확인해야 할 곳:
  앱 문제    → CloudWatch (Lambda/RDS)
  이미지 문제 → Cloudflare Analytics (R2/CDN)
  개발 환경  → Vercel Dashboard
```

**심각도: 중** — 1인 운영인데 모니터링 포인트가 3곳. 장애 원인 추적 시 "어디 문제인지" 판단이 한 단계 더 필요.

---

## 2. Lambda → R2 업로드 레이턴시

```
순수 AWS:     Lambda(서울) → S3(서울) = ~10ms (같은 리전, 같은 네트워크)
하이브리드:   Lambda(서울) → R2(자동 리전) = ~50~200ms (인터넷 경유)
```

**영향받는 기능:**

| 기능 | 영향 | 이유 |
|---|---|---|
| 갤러리 이미지 업로드 | 체감 가능하지만 허용 범위 | 1장씩 업로드 |
| AI 생성 이미지 저장 | 무시 가능 | AI 생성 자체가 10~30초 |
| 배치 생성 5장 | 누적 +500ms | SSE라서 각각 전송, 큰 문제 아님 |
| 참조 사진 업로드 | 미미 | 1장씩 |

**심각도: 낮** — 실 사용 시나리오에서 유의미한 영향 없음. 다만 스테이징에서 측정 필요.

---

## 3. R2 ≠ S3 (미세한 API 차이)

R2는 S3 "호환"이지 S3 "동일"이 아님.

### 지원 안 되는 S3 기능

| S3 기능 | R2 지원 | 이 프로젝트에서 사용 |
|---|---|---|
| S3 Select | 미지원 | 안 씀 |
| S3 Object Lock (WORM) | 미지원 | 안 씀 |
| S3 Inventory | 미지원 | 안 씀 |
| S3 Batch Operations 일부 | 미지원 | 안 씀 |
| S3 Event Notifications | 미지원 | **주의** — 현재 안 쓰지만 추후 가능성 |

### 지원되지만 다르게 동작

| API | S3 | R2 | 영향 |
|---|---|---|---|
| DeleteObjects | 최대 1000개/요청 | **최대 100개/요청** | **Cron cleanup 수정 필요** |
| ListObjectsV2 | MaxKeys 기본 1000 | MaxKeys 기본 다름 | 코드에서 명시하면 OK |
| CopyObject | 5GB | 5GB | 동일 |
| Multipart Upload | 지원 | 지원 (파트 제한 다름) | 큰 파일 없으면 OK |

### 이 프로젝트에서 실제 사용 중인 API

| 사용 중인 API | R2 호환 | 조치 |
|---|---|---|
| PutObjectCommand | OK | 변경 없음 |
| GetObjectCommand | OK | 변경 없음 |
| DeleteObjectsCommand | **주의** | 배치 크기 1000 → 100으로 변경 |
| HeadObjectCommand | OK | 변경 없음 |
| ListObjectsV2Command | OK | MaxKeys 명시 권장 |

**심각도: 중** — `DeleteObjectsCommand` 배치 크기를 100으로 변경 필수. 놓치면 런타임 에러.

---

## 4. Cloudflare 단일 장애점 (이미지)

```
R2 장애 시:
  → 모든 이미지 로딩 실패
  → 청첩장 공개 뷰가 이미지 없이 렌더링
  → AI 생성 이미지 업로드 실패
  → OG 이미지 깨짐 (카카오톡 공유 시 미리보기 없음)
```

| 서비스 | SLA | 월 허용 다운타임 |
|---|---|---|
| Cloudflare R2 | 99.9% | 43분 |
| AWS S3 | 99.9% | 43분 |

순수 AWS였어도 S3 장애 = 동일한 영향. SLA 수준은 같으니 리스크 증가는 아님.

**다만**: AWS 안에서 S3 → Lambda 간 장애는 내부 네트워크라 복원이 빠름. R2 장애 시 Lambda → R2 외부 통신이라 AWS 쪽에서 할 수 있는 게 없음.

**완화**: S3 fallback 코드가 있으므로 환경변수 하나로 즉시 전환 가능.

**심각도: 낮~중** — SLA 동등. 장애 시 제어권이 분산되지만 fallback으로 커버.

---

## 5. DNS 분리에 따른 복잡도

```
cuggu.com      → Route 53 (AWS)
img.cuggu.com  → Cloudflare DNS

문제 시나리오:
  1. 도메인 갱신 실수 → 양쪽 다 확인해야
  2. SSL 인증서 만료 → AWS ACM + Cloudflare 각각 관리
  3. DNS 전파 지연 → 두 시스템이 서로 다른 속도
```

**심각도: 낮** — 둘 다 자동 갱신. "어디서 관리하더라?" 하고 헷갈릴 수 있지만 문서화로 충분.

---

## 6. 개발/상용 환경 분기

```
개발 (Vercel):    S3 + Supabase
상용 (AWS+R2):    R2 + RDS
```

### 리스크 시나리오

**6-1. "개발에서 됐는데 상용에서 안 됨"**

| 원인 | 예시 | 대응 |
|---|---|---|
| R2 API 차이 | DeleteObjects 100개 제한 | 개발에서도 100개 제한으로 코딩 |
| RDS 커넥션 풀 | Supabase는 자체 풀링, RDS Proxy는 다름 | 스테이징 테스트 |
| Lambda cold start | Vercel은 cold start 패턴이 다름 | 스테이징에서 성능 측정 |
| VPC 네트워크 | 개발은 퍼블릭 인터넷, 상용은 VPC 내부 | 보안그룹 테스트 |

**6-2. Drizzle 마이그레이션 동기화 누락**

```
개발: pnpm db:push → Supabase
상용: pnpm db:push → RDS (DATABASE_URL 변경 후)

한쪽만 적용하고 잊을 수 있음
→ 상용 배포 시 스키마 불일치로 런타임 에러
```

**대응**: 배포 체크리스트에 DB 마이그레이션 포함. CI에서 자동화 검토.

**6-3. 이미지 URL 불일치**

```
개발: xxx.cloudfront.net/gallery/...
상용: img.cuggu.com/gallery/...
```

**대응**: 코드에서 `IMAGE_DOMAIN` 환경변수로 분기 처리 필수. 하드코딩된 URL이 있으면 버그.

**심각도: 중** — 가장 현실적인 리스크. 환경 차이로 인한 이슈가 주기적으로 발생할 수 있음.

---

## 7. 비용 예측 불확실성

### R2 과금 모델

| 항목 | 무료 티어 | 초과 시 |
|---|---|---|
| 스토리지 | 10GB/월 | $0.015/GB |
| Class A (쓰기) | 100만 요청/월 | $4.50/100만 |
| Class B (읽기) | 1000만 요청/월 | $0.36/100만 |
| 이그레스 | **무제한** | **$0** |

### 잠재 비용 폭탄 시나리오

| 시나리오 | Class A 요청 | 비용 |
|---|---|---|
| 월 1만 장 AI 생성 | ~1만 | 무료 티어 내 |
| 월 10만 장 AI 생성 | ~10만 | 무료 티어 내 |
| 월 100만 장 AI 생성 | ~100만 | 무료 티어 경계 ($0~4.50) |

S3 PUT 비용($5/100만)보다 저렴. Cloudflare CDN 캐시 히트율이 높으면 R2 직접 읽기 요청도 감소.

**심각도: 낮** — 오히려 S3보다 저렴. 이그레스 무료가 결정적.

---

## 8. 벤더 락인 분산

```
순수 AWS:     AWS에 올인 → AWS 가격 인상 시 전부 영향
하이브리드:   AWS(컴퓨팅/DB) + Cloudflare(스토리지) → 분산
```

| 이동 시나리오 | 난이도 | 소요 |
|---|---|---|
| R2 → S3 복귀 | **쉬움** | 환경변수 변경 + rclone sync (1시간) |
| R2 → 다른 S3 호환 | **쉬움** | S3 API 호환이라 어디든 |
| AWS → 다른 클라우드 | 큼 | Lambda/RDS 전체 마이그레이션 |

**심각도: 오히려 긍정적** — 이미지 스토리지의 이식성이 높아짐.

---

## 리스크 매트릭스

| # | 리스크 | 발생 확률 | 영향도 | 종합 | 대응 |
|---|---|---|---|---|---|
| 1 | **DeleteObjects 100개 제한** | 높음 | 중 | **높음** | 코드에서 배치 크기 100으로 변경 |
| 2 | **개발/상용 환경 차이 버그** | 중 | 중 | **중** | 스테이징 테스트 철저히 + CI |
| 3 | **DB 마이그레이션 동기화 누락** | 중 | 높 | **중** | 배포 체크리스트 + CI 연동 |
| 4 | **운영 모니터링 분산** | 높음 | 낮 | **중** | 알림을 한 곳(슬랙)으로 통합 |
| 5 | Lambda→R2 레이턴시 | 낮 | 낮 | 낮 | 스테이징에서 측정 후 판단 |
| 6 | R2 장애 | 낮 | 높 | 낮 | S3 fallback 코드 (환경변수 전환) |
| 7 | DNS 관리 혼란 | 낮 | 낮 | 낮 | 문서화 |
| 8 | 비용 폭탄 | 낮 | 중 | 낮 | R2 무료 티어 + 이그레스 $0 |

---

## 필수 대응 항목 (마이그레이션 전 해결)

```
[P0] DeleteObjectsCommand 배치 크기 100으로 변경
     → Cron cleanup + 갤러리 삭제 + AI 이미지 삭제 코드 전부

[P1] lib/storage/client.ts에 S3/R2 분기 로직 구현
     → R2_ENDPOINT 유무로 자동 전환, S3 fallback 보장

[P1] 배포 체크리스트에 DB 마이그레이션 동기화 포함
     → "상용 DB에도 마이그레이션 적용했는가?" 항목

[P2] 모니터링 알림 통합
     → CloudWatch + Cloudflare → 슬랙/디스코드 단일 채널

[P2] 이미지 URL 하드코딩 검사
     → cloudfront.net 직접 참조하는 코드 없는지 grep
```

---

## 결론

```
치명적 리스크: 없음
  - R2 → S3 롤백이 환경변수 하나로 가능 (최강 안전망)
  - 최악의 경우 이미지만 S3로 복귀, 앱은 영향 없음

가장 큰 리스크: "개발/상용 환경 차이" + "관리 포인트 분산"
  - 기술적 문제가 아닌 운영 습관의 문제
  - 체크리스트와 모니터링 통합으로 충분히 관리 가능

코드 레벨에서 반드시 챙길 것:
  1. DeleteObjects 배치 크기 100
  2. 이미지 URL을 환경변수 기반으로 조합
  3. S3/R2 겸용 클라이언트 (환경변수 분기)
```
