# 아키텍처 개요

Cuggu 시스템의 전체 아키텍처를 설명합니다.

---

## 시스템 구성도

```
┌─────────────────────────────────────────────────────────────────┐
│                         클라이언트                               │
│                    (Next.js App Router)                         │
└─────────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────────┐
│                      Next.js API Routes                         │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐        │
│  │   Auth   │  │ Invitation│  │    AI    │  │  Payment │        │
│  │   API    │  │    API    │  │   API    │  │   API    │        │
│  └──────────┘  └──────────┘  └──────────┘  └──────────┘        │
└─────────────────────────────────────────────────────────────────┘
        │               │               │               │
        ▼               ▼               ▼               ▼
┌───────────┐   ┌───────────┐   ┌───────────┐   ┌───────────┐
│  NextAuth │   │ PostgreSQL│   │ Replicate │   │   Toss    │
│  (Kakao)  │   │ (Supabase)│   │    API    │   │ Payments  │
└───────────┘   └───────────┘   └───────────┘   └───────────┘
                      │
                      ▼
              ┌───────────────┐
              │  Drizzle ORM  │
              └───────────────┘

┌───────────────────────────────────────────────────────────────┐
│                        스토리지                                │
│   ┌──────────────┐              ┌──────────────┐              │
│   │   AWS S3     │─────────────▶│  CloudFront  │              │
│   │  (이미지)    │              │    (CDN)     │              │
│   └──────────────┘              └──────────────┘              │
└───────────────────────────────────────────────────────────────┘

┌───────────────────────────────────────────────────────────────┐
│                         캐시                                   │
│                   ┌──────────────┐                            │
│                   │ Upstash Redis│                            │
│                   └──────────────┘                            │
└───────────────────────────────────────────────────────────────┘
```

---

## 주요 컴포넌트

### Frontend (Next.js 16 App Router)

| 디렉토리 | 설명 |
|----------|------|
| `app/` | 라우트 및 페이지 컴포넌트 |
| `components/` | 재사용 가능한 UI 컴포넌트 |
| `components/editor/` | 청첩장 편집기 (핵심 기능) |
| `lib/` | 유틸리티 및 비즈니스 로직 |
| `stores/` | Zustand 상태 관리 |

### Backend (API Routes)

| 엔드포인트 | 설명 |
|------------|------|
| `/api/auth/*` | NextAuth.js 인증 |
| `/api/invitations/*` | 청첩장 CRUD |
| `/api/ai/generate` | AI 이미지 생성 |
| `/api/upload` | 이미지 업로드 |

### Database

**주요 테이블:**
- `users` - 사용자 정보
- `invitations` - 청첩장 데이터
- `rsvps` - 참석 여부 응답
- `ai_generations` - AI 생성 이력
- `payments` - 결제 정보

스키마 정의: `db/schema.ts`

---

## AI 기능 아키텍처

```
사용자 요청
     │
     ▼
┌──────────────┐
│ /api/ai/     │
│  generate    │
└──────────────┘
     │
     ▼
┌──────────────┐
│ lib/ai/      │
│ replicate.ts │
└──────────────┘
     │
     ├─────────────────┬─────────────────┐
     ▼                 ▼                 ▼
┌──────────┐    ┌──────────┐    ┌──────────────┐
│ Flux Pro │    │ Flux Dev │    │  PhotoMaker  │
│(고품질)  │    │(빠른생성)│    │(인물 합성)   │
└──────────┘    └──────────┘    └──────────────┘
     │                 │                 │
     └─────────────────┴─────────────────┘
                       │
                       ▼
              ┌──────────────┐
              │   S3 저장    │
              └──────────────┘
```

---

## 데이터 흐름

### 청첩장 생성 플로우

```
1. 사용자 로그인 (카카오)
2. 새 청첩장 생성
3. 편집기에서 정보 입력
   - 기본 정보 (이름, 날짜, 장소)
   - 갤러리 이미지 업로드
   - AI 이미지 생성 (선택)
   - 계좌 정보 입력
4. 템플릿 선택
5. 미리보기 확인
6. 결제 (Toss)
7. 청첩장 공개 URL 생성
8. 카카오톡 공유
```

---

## 보안 고려사항

- **인증**: NextAuth.js + 카카오 OAuth
- **API 보안**: 세션 기반 인증, CSRF 보호
- **데이터**: 민감 정보 암호화, SQL Injection 방지 (Drizzle ORM)
- **업로드**: 파일 타입/크기 검증, S3 presigned URL 사용
